<!-- app/views/conversations/show.html.erb -->
<div class="container-fluid min-vh-100 py-4" data-controller="chat-scroll">
  <div class="row justify-content-center">
    <div class="col-12 col-lg-8">

      <!-- Header -->
      <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
          <h1 class="dreamlog-title mb-0">
            <i class="fas fa-comments me-2"></i><%= @conversation.title %>
          </h1>
          <p class="text-white-50 small mb-0">
            <i class="far fa-clock me-1"></i>
            Créée <%= time_ago_in_words(@conversation.created_at) %> ago
          </p>
        </div>
        <div class="d-flex gap-2">
          <%= link_to conversations_path, class: "btn btn-outline-light" do %>
            <i class="fas fa-arrow-left me-2"></i>Retour
          <% end %>
          <%= link_to archive_conversation_path(@conversation), method: :patch, class: "btn btn-outline-warning" do %>
            <i class="fas fa-archive"></i>
          <% end %>
        </div>
      </div>

      <!-- Zone des messages -->
      <div class="card glass-card mb-4" style="min-height: 500px; max-height: 600px; overflow-y: auto;" data-chat-scroll-target="container">
        <div class="card-body">
          <% if @messages.any? %>
            <% @messages.each do |message| %>
              <div class="mb-4 <%= message.from_user? ? 'text-end' : 'text-start' %>">
                <div class="d-inline-block p-3 rounded <%= message.from_user? ? 'bg-primary text-white' : 'bg-secondary text-white' %>" style="max-width: 75%;">
                  <div class="d-flex align-items-center mb-2">
                    <% if message.from_user? %>
                      <i class="fas fa-user-circle me-2"></i>
                      <strong>Vous</strong>
                    <% else %>
                      <i class="fas fa-robot me-2"></i>
                      <strong>Assistant AI</strong>
                    <% end %>
                  </div>
                  <div class="message-content" style="white-space: pre-wrap; word-wrap: break-word;">
                    <%= message.content %>
                  </div>
                  <div class="text-end mt-2 opacity-75 small">
                    <%= message.created_at.strftime("%H:%M") %>
                  </div>
                </div>
              </div>
            <% end %>
          <% else %>
            <div class="text-center text-white-50 py-5">
              <i class="fas fa-comments fa-4x mb-3 opacity-50"></i>
              <p>Aucun message pour le moment. Commencez la conversation !</p>
            </div>
          <% end %>
        </div>
      </div>

      <!-- Formulaire d'envoi de message -->
      <div class="card glass-card">
        <div class="card-body">
          <%= form_with model: @new_message,
              url: conversation_messages_path(@conversation),
              method: :post,
              local: true,
              data: {
                controller: "chat-form",
                chat_form_target: "form"
              } do |f| %>
          <div class="input-group">
            <%= f.text_area :content,
                class: "form-control bg-dark text-white border-0",
                placeholder: "Tapez votre message... (Enter pour envoyer, Shift+Enter pour nouvelle ligne)",
                rows: 3,
                style: "resize: none;",
                data: {
                  chat_form_target: "textarea",
                  action: "keydown->chat-form#handleKeydown"
                } %>
            <button type="submit" class="btn btn-primary">
              <i class="fas fa-paper-plane me-2"></i>Envoyer
            </button>
          </div>
        <% end %>
        </div>
      </div>

    </div>
  </div>
</div>
